<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/css?family=Material+Icons+Round" rel="stylesheet">
    <!-- OR Material Symbols -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <title>Quản lý câu hỏi</title>
    <link rel="icon" type="image/png" href="/images/logo.png">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
    </style>
</head>
<body class="bg-purple-50">
<div class="container mx-auto p-4 max-w-7xl">

    <!--  navbar-->
    <div th:replace="fragment/navbar :: navbar"></div>

    <div class="bg-white p-6 rounded-lg shadow-md">

        <nav class="flex items-center space-x-1 text-gray-500 text-sm mb-10 select-none">
            <i class="fas fa-home"></i>
            <svg
                    class="w-3 h-3 mx-2"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
            >
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path>
            </svg>
            <span>Quản lý câu hỏi</span>
        </nav>

        <div class="flex justify-end mb-10">
            <button
                    type="button"
                    class="bg-green-600 text-white text-sm font-medium px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-blue-500 add-btn"
            >
                Thêm bộ câu hỏi mới
            </button>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-8">
            <a th:each="ls, iterStat : ${examList}"
               th:href="@{'/admin/questionList/{key}' (key=${ls.examId})}"
               class="block bg-white rounded-xl shadow-[0_10px_30px_rgba(0,0,0,0.1)] h-28 flex items-center justify-center text-center px-4 hover:shadow-lg transition no-underline text-gray-900 font-normal">
                <span th:text="${ls.examName}"></span>
            </a>
        </div>
    </div>

    <!-- add Question Modal -->
    <div id="addModel" aria-labelledby="modal-title" aria-modal="true"
         style="background-color: #000000a8;"
         class="fixed inset-0 flex items-center justify-center z-50 " role="dialog"
         th:classappend="${errorAdd} != null ? '' : ' hidden'">
        <div class="bg-white rounded-lg shadow-lg w-[700px] max-w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-lg font-semibold text-gray-900 select-none" id="modal-title">
                    Thêm bộ câu hỏi số: <span th:text="${questionTypes.size()+1}"></span>
                </h1>
                <button type="button" onclick="closeEditModal()"
                        class="text-gray-500 hover:text-gray-700 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <h2 style="color: red">Vui lòng thêm ít nhất một câu hỏi cho bộ câu hỏi này!</h2>
            <h2 style="color: red" th:text="${errorAdd}"></h2>
            <form id="addQuestionForm" class="space-y-4 text-sm text-gray-700">
                <input type="hidden" id="quesType" name="quesType" th:value="${examList.size()+1}"/>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="quesContent">
                        Nội dung câu hỏi:
                    </label>
                    <textarea
                            id="quesContent"
                            name="quesContent"
                            rows="3"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent"
                            required
                    ></textarea>
                </div>

                <div class="border-t border-gray-200 pt-4">
                    <div id="add-answers-container" class="space-y-4 mb-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-sm font-medium text-gray-700">Các đáp án: <span
                                    class="text-xs text-gray-500">(tối đa 4 đáp án)</span></h3>
                            <span id="add-answers-count"
                                  class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">0/4</span>
                        </div>
                        <div id="add-answers-list" class="space-y-3">
                            <!-- Đáp án sẽ được thêm vào đây bằng JavaScript -->
                        </div>

                        <div class="mt-2 flex items-center">
                            <button
                                    type="button"
                                    id="add-new-answer-btn"
                                    class="text-xs px-3 py-1 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500"
                            >
                                Thêm đáp án
                            </button>
                            <p id="add-answer-limit-message" class="text-xs text-orange-500 ml-3 hidden">
                                Đã đạt giới hạn tối đa 4 đáp án
                            </p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300"
                            type="button"
                            onclick="closeEditModal()">
                        Hủy
                    </button>
                    <button
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300"
                            type="submit">
                        Lưu
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
        const MAX_ANSWERS = 4;
        // add ques button event listeners
        const editButtons = document.querySelectorAll('.add-btn');
        editButtons.forEach(button => {
            button.addEventListener('click', function (event) {
                event.preventDefault();

                // Initialize the add question form
                const addAnswersList = document.getElementById('add-answers-list');
                addAnswersList.innerHTML = '';

                // Add initial answer field
                addNewAnswerInput(addAnswersList, '', false, 0);
                updateAddAnswerCounter(1);

                // Show the modal
                document.getElementById('addModel').classList.remove('hidden');
            });
        });


        // Function to close edit modal
        function closeEditModal() {
            document.getElementById('addModel').classList.add('hidden');
        }

        // Function to renumber answers after deletion in add form
        function renumberNewAnswers() {
            const answersList = document.getElementById('add-answers-list');
            const answers = answersList.querySelectorAll('div.flex.items-start');

            answers.forEach((answer, index) => {
                // Update the name attributes to have sequential indices
                const textInput = answer.querySelector('input[type="text"]');
                textInput.name = `newAnswers[${index}].answerContent`;

                const radioInput = answer.querySelector('input[type="radio"]');
                radioInput.value = index;
            });
        }

        // Add Answer button event listener for add form
        document.getElementById('add-new-answer-btn').addEventListener('click', function () {
            const answersList = document.getElementById('add-answers-list');
            const currentCount = answersList.querySelectorAll('div.flex.items-start').length;

            // Check if we've reached the maximum allowed answers
            if (currentCount < MAX_ANSWERS) {
                addNewAnswerInput(answersList, '', false, currentCount);
                updateAddAnswerCounter(currentCount + 1);
            }
        });


        // Validate add form before submission
        document.getElementById('addQuestionForm').addEventListener('submit', function (event) {
            const answersList = document.getElementById('add-answers-list');
            const answers = answersList.querySelectorAll('div.flex.items-start');

            if (answers.length <= 1) {
                event.preventDefault();
                alert('Vui lòng thêm ít nhất hai đáp án cho câu hỏi.');
                return false;
            }

            // Ensure at least one answer is marked as correct
            const correctAnswer = answersList.querySelector('input[name="newCorrectAnswerIndex"]:checked');
            if (!correctAnswer) {
                event.preventDefault();
                alert('Vui lòng chọn một đáp án đúng.');
                return false;
            }

            return true;
        });

        // Function to add answer input fields to the add form
        function addNewAnswerInput(container, content = '', isCorrect = false, index) {
            const answerDiv = document.createElement('div');
            answerDiv.className = 'flex items-start space-x-2';

            // Unique ID for each answer
            const uniqueId = 'new-' + Date.now() + '-' + index;

            answerDiv.innerHTML = `
                <div class="flex-grow">
                    <input
                        type="text"
                        name="newAnswers[${index}].answerContent"
                        value="${content}"
                        class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent"
                        placeholder="Nhập nội dung đáp án"
                        required
                    >
                </div>
                <div class="flex items-center space-x-2 pt-2">
                    <input
                        type="radio"
                        name="newCorrectAnswerIndex"
                        id="correct-${uniqueId}"
                        value="${index}"
                        ${isCorrect ? 'checked' : ''}
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 cursor-pointer"
                    >
                    <label for="correct-${uniqueId}" class="text-xs text-gray-700 cursor-pointer">Đáp án đúng</label>
                    <button
                        type="button"
                        class="text-red-500 hover:text-red-700 focus:outline-none delete-new-answer-btn"
                        aria-label="Xóa đáp án"
                    >
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;

            container.appendChild(answerDiv);

            // Add event listener to delete button
            const deleteBtn = answerDiv.querySelector('.delete-new-answer-btn');
            deleteBtn.addEventListener('click', function () {
                answerDiv.remove();
                // Renumber the answers
                renumberNewAnswers();
                // Update counter
                const currentCount = container.querySelectorAll('div.flex.items-start').length;
                updateAddAnswerCounter(currentCount);
            });
        }

        // Function to update the answer counter for Add modal
        function updateAddAnswerCounter(count) {
            const counterElement = document.getElementById('add-answers-count');
            counterElement.textContent = `${count}/${MAX_ANSWERS}`;

            const addNewAnswerBtn = document.getElementById('add-new-answer-btn');
            const limitMessage = document.getElementById('add-answer-limit-message');

            if (count >= MAX_ANSWERS) {
                addNewAnswerBtn.disabled = true;
                addNewAnswerBtn.classList.add('opacity-50', 'cursor-not-allowed');
                limitMessage.classList.remove('hidden');
            } else {
                addNewAnswerBtn.disabled = false;
                addNewAnswerBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                limitMessage.classList.add('hidden');
            }
        }


        //submit form add bộ câu hỏi
        document.getElementById('addQuestionForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent default form submission

            const answersList = document.getElementById('add-answers-list');
            const answers = answersList.querySelectorAll('div.flex.items-start');

            if (answers.length <= 1) {
                alert('Vui lòng thêm ít nhất hai đáp án cho câu hỏi.');
                return false;
            }

            // Ensure at least one answer is marked as correct
            const correctAnswer = answersList.querySelector('input[name="newCorrectAnswerIndex"]:checked');
            if (!correctAnswer) {
                alert('Vui lòng chọn một đáp án đúng.');
                return false;
            }

            // Get form data
            const questionContent = document.getElementById('quesContent').value;
            const questionType = document.getElementById('quesType').value;

            // tạo một formdata để gửi sang controller
            const formData = new FormData();
            formData.append('quesContent', questionContent);
            formData.append('quesType', questionType);
            formData.append('newCorrectAnswerIndex', correctAnswer.value);

            // Add answer data
            answers.forEach((element, index) => {
                const content = element.querySelector('input[type="text"]').value;
                formData.append(`newAnswers[${index}].answerContent`, content);
            });

            // Show loading indicator
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
            submitButton.disabled = true;

            // Submit using fetch
            fetch('/admin/addQues', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Server returned status: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Handle success
                        closeEditModal();
// Lấy thông tin câu hỏi mới
                        const question = data.question;

// Tạo phần tử mới cho bộ câu hỏi
                        const newQuestionCard = document.createElement('a');
                        newQuestionCard.href = `/admin/questionList/${question.questionType}`;
                        newQuestionCard.className = 'block bg-white rounded-xl shadow-[0_10px_30px_rgba(0,0,0,0.1)] h-28 flex items-center justify-center text-center px-4 hover:shadow-lg transition no-underline text-gray-900 font-normal';
                        newQuestionCard.innerHTML = `<span>${question.examName}</span>`;  // bạn có thể đổi thành question.questionContent nếu muốn

// Thêm vào danh sách
                        document.querySelector('.grid').appendChild(newQuestionCard);
                        const quesTypeInput = document.getElementById('quesType');
                        quesTypeInput.value = parseInt(quesTypeInput.value) + 1;

                        // Cập nhật lại tiêu đề modal
                        const modalTitleSpan = document.querySelector('#modal-title span');
                        modalTitleSpan.textContent = quesTypeInput.value;
                    }


                })
                .catch(error => {
                    console.error('Error adding question:', error);
                    showNotification('Lỗi', 'Có lỗi khi thêm câu hỏi. Vui lòng thử lại sau.', 'error');
                })
                .finally(() => {
                    // Restore button state
                    submitButton.innerHTML = originalButtonText;
                    submitButton.disabled = false;
                });
        });
    </script>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>